// src/chart/chart.controller.ts
import { Controller, Get, Res } from '@nestjs/common';
import { Response } from 'express';
import { ChartService } from 'src/chart/chart.service';
import { KalmanFilter } from 'src/kalman-filter/src';

@Controller('chart')
export class ChartController {
  constructor(private readonly chartService: ChartService) { }

  @Get()
  getChartSvg(@Res() res: Response): void {
    let rounds: string[] = [];
    let meas: { x: number; y: number }[] = [];
    let pred: { x: number; y: number }[] = [];
    let corr: { x: number; y: number }[] = [];

    const initialState = {
      x: 80.40765333333334,
      y: 8.06221,
      vx: 0,
      vy: 0
    };

    const kalmanFilter = new KalmanFilter(initialState);

    // measurements format: {x: 2, y: 2, vx: 1, vy: 2},
    const measurements = [
    {
      x: 80.40765333333334,
      y: 8.06221,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765499999999,
      y: 8.06221,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765333333334,
      y: 8.06221,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765333333334,
      y: 8.06221,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765333333334,
      y: 8.06221,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765333333334,
      y: 8.06221,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765499999999,
      y: 8.062211666666666,
      vx: 0,
      vy: 0
    },
    {
      x: 80.40765499999999,
      y: 8.062211666666666,
      vx: 6.455184844663662,
      vy: 0.020628439668794194
    },
    {
      x: 80.407615,
      y: 8.062336111111112,
      vx: 9.724861822310494,
      vy: 6.667839621380504
    },
    {
      x: 80.40738666666667,
      y: 8.062404444444445,
      vx: 11.242994845008892,
      vy: -8.585631111636144
    },
    {
      x: 80.40736833333332,
      y: 8.062415,
      vx: -0.1424806177467648,
      vy: 0.0912978561770842
    },
    {
      x: 80.40736166666667,
      y: 8.062416666666667,
      vx: -0.12311433069050161,
      vy: 0.12311433069050161
    },
    {
      x: 80.40735333333333,
      y: 8.062416666666667,
      vx: -0.12311433069050161,
      vy: 0.12311433069050161
    },
    {
      x: 80.40735166666666,
      y: 8.062416666666667,
      vx: -0.12311433069050161,
      vy: 0.12311433069050161
    },
    {
      x: 80.40720666666667,
      y: 8.062461666666668,
      vx: 19.369121869008396,
      vy: 7.273460668235083
    },
    {
      x: 80.40681,
      y: 8.062585,
      vx: 30.906085662092723,
      vy: 15.507206202142083
    },
    {
      x: 80.406265,
      y: 8.062753333333333,
      vx: 39.24111761929039,
      vy: 18.92922180932891
    },
    {
      x: 80.40558666666666,
      y: 8.062956111111111,
      vx: 41.78305815375031,
      vy: 20.28198446446771
    },
    {
      x: 80.40495333333334,
      y: 8.06314,
      vx: 41.85533137634337,
      vy: 20.189548327964732
    },
    {
      x: 80.404215,
      y: 8.063360555555555,
      vx: 40.89422505879919,
      vy: 19.220954346746004
    },
    {
      x: 80.40337833333334,
      y: 8.063612222222223,
      vx: 39.23999074484991,
      vy: 18.313233470077297
    },
    {
      x: 80.40255666666667,
      y: 8.063860555555555,
      vx: 37.83827055841535,
      vy: 17.47370370362028
    },
    {
      x: 80.40177166666667,
      y: 8.064120555555556,
      vx: 36.64404381828622,
      vy: 16.700622520278306
    },
    {
      x: 80.40103999999999,
      y: 8.064372222222222,
      vx: 35.62452267015779,
      vy: 15.989556200948566
    },
    {
      x: 80.400375,
      y: 8.06462,
      vx: 34.7543473004961,
      vy: 15.335013980874594
    },
    {
      x: 80.39978499999999,
      y: 8.064860555555555,
      vx: 34.01177431116836,
      vy: 14.731188706963952
    },
    {
      x: 80.399275,
      y: 8.065095555555556,
      vx: 33.37782947422079,
      vy: 14.172795020929796
    },
    {
      x: 80.39884833333334,
      y: 8.065326111111112,
      vx: 32.835628253998005,
      vy: 13.654995328600794
    },
    {
      x: 80.39850499999999,
      y: 8.065555,
      vx: 32.37055184980275,
      vy: 13.173346985501314
    },
    {
      x: 80.39824499999999,
      y: 8.06578111111111,
      vx: 31.970736067800065,
      vy: 12.723707993226454
    },
    {
      x: 80.3980675,
      y: 8.066001666666666,
      vx: 31.626133936297006,
      vy: 12.302251262125746
    },
    {
      x: 80.39796999999999,
      y: 8.066213333333334,
      vx: 31.32862930389928,
      vy: 11.90594527256644
    },
    {
      x: 80.3979475,
      y: 8.066413888888889,
      vx: 31.071244113862977,
      vy: 11.532287934943736
    },
    {
      x: 80.39799416666666,
      y: 8.0666,
      vx: 30.848420465283666,
      vy: 11.179140847153238
    },
    {
      x: 80.39810166666667,
      y: 8.066768333333334,
      vx: 30.655209268285446,
      vy: 10.844659612970895
    },
    {
      x: 80.39825833333334,
      y: 8.066915555555556,
      vx: 30.487451470533003,
      vy: 10.527263689936064
    },
    //Noise
    {
      x: 80.39946426677767,
      y: 8.067040454455544,
      vx: 30.341813074432792,
      vy: 10.22562576823239
    },
    {
      x: 80.39867999999999,
      y: 8.067137777777777,
      vx: 30.214771887122743,
      vy: 9.938626501656978
    },
    {
      x: 80.39892916666667,
      y: 8.06720888888889,
      vx: 30.103566593487494,
      vy: 9.665336324338838
    },
    {
      x: 80.39919583333334,
      y: 8.067251666666667,
      vx: 30.005036772919697,
      vy: 9.404099078828333
    },
    {
      x: 80.39947333333333,
      y: 8.067265,
      vx: 29.91669212324087,
      vy: 9.153412547237554
    },
    {
      x: 80.3997575,
      y: 8.067248888888889,
      vx: 29.83659832718477,
      vy: 8.911967637173264
    },
    {
      x: 80.40004333333333,
      y: 8.067203333333334,
      vx: 29.76327559868358,
      vy: 8.6785974402409
    },
    {
      x: 80.40032666666667,
      y: 8.067129444444445,
      vx: 29.695556823175054,
      vy: 8.452243396742745
    },
    {
      x: 80.40060416666667,
      y: 8.067027777777778,
      vx: 29.63251149789049,
      vy: 8.232918097287668
    },
    {
      x: 80.40087333333333,
      y: 8.066899444444444,
      vx: 29.573407510187235,
      vy: 8.01972204253751
    },
    ];

    for (let i = 0; i < measurements.length; i++) {
      rounds.push(`Round ${i + 1}`);
      meas.push({ x: measurements[i].x, y: measurements[i].y });

      const dt = 10;
      kalmanFilter.predict(dt);

      const currentState = kalmanFilter.getState();
      pred.push({ x: currentState.x, y: currentState.y });

      kalmanFilter.correct(measurements[i]);

      const currentState1 = kalmanFilter.getState();
      corr.push({ x: currentState1.x, y: currentState1.y });
    }

    const svg = this.chartService.generateChartSvg(meas, pred, corr);
    res.send({
      'predictions': pred,
      'corrections': corr,
      'measurements': meas,
    });
  }
}
